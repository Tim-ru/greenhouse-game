# Система очистки плесени - Инструкция по интеграции

## Обзор системы

Система очистки плесени позволяет игрокам использовать струю воды для стирания плесени с поверхностей в реальном времени. Система полностью интегрирована с существующей системой взаимодействий и инвентарем.

### Интеграция с существующими системами:

- **InteractionDetector**: Плесень автоматически обнаруживается и имеет высокий приоритет взаимодействия
- **InventorySystem**: Требует наличие лейки с водой в инвентаре для очистки
- **IInteractable**: Полная совместимость с существующей системой взаимодействий
- **YSorter**: Автоматическая правильная сортировка спрайтов

### Приоритеты взаимодействия:
1. Полив растений (лейка + вода) - приоритет 100
2. **Взятие шланга (лейка + вода) - приоритет 98** ⭐
3. **Очистка плесени (лейка + вода) - приоритет 95** ⭐
4. Подбор лейки - приоритет 90
5. Взятие шланга (без лейки) - приоритет 88
6. Очистка плесени (без лейки) - приоритет 85
7. Полив растений (без лейки) - приоритет 80

## Компоненты системы

### 1. MoldSurface
**Назначение**: Основной компонент для редактируемой текстуры плесени
**Файл**: `Assets/_Project/Scripts/Cleaning/MoldSurface.cs`

### 2. WaterJetController  
**Назначение**: Контроллер струи воды, обрабатывает ввод и raycast
**Файл**: `Assets/_Project/Scripts/Cleaning/WaterJetController.cs`

### 3. JetVFX
**Назначение**: Визуальные эффекты струи воды
**Файл**: `Assets/_Project/Scripts/Cleaning/JetVFX.cs`

### 4. MoldInteractable
**Назначение**: Интеграция плесени с системой взаимодействий
**Файл**: `Assets/_Project/Scripts/Cleaning/MoldInteractable.cs`

### 5. MoldPrefabCreator
**Назначение**: Утилита для создания тестовых объектов плесени
**Файл**: `Assets/_Project/Scripts/Cleaning/MoldPrefabCreator.cs`

### 6. HoseInteractable
**Назначение**: Компонент для взаимодействия со шлангом
**Файл**: `Assets/_Project/Scripts/Cleaning/HoseInteractable.cs`

### 7. HoseEquipment
**Назначение**: Управление шлангом в руках игрока
**Файл**: `Assets/_Project/Scripts/Cleaning/HoseEquipment.cs`

### 8. HosePrefabCreator
**Назначение**: Утилита для создания шлангов в сцене
**Файл**: `Assets/_Project/Scripts/Cleaning/HosePrefabCreator.cs`

### 9. SceneSetupHelper
**Назначение**: Помощник для быстрой настройки сцены с реальными объектами
**Файл**: `Assets/_Project/Scripts/Cleaning/SceneSetupHelper.cs`

### 10. YSorter
**Назначение**: Утилита для правильной сортировки спрайтов по Y-координате
**Файл**: `Assets/_Project/Scripts/Player/YSorter.cs` (существующий компонент)

## Пошаговая интеграция

### Шаг 1: Создание шланга в сцене

#### Вариант A: Использование HosePrefabCreator (рекомендуется)
1. Создайте пустой GameObject в сцене
2. Добавьте компонент `HosePrefabCreator`
3. Настройте параметры:
   - **Create On Start**: `true` (автоматически создать при запуске)
   - **Position**: координаты где разместить шланг (например, в углу комнаты)
   - **Hose Sprite**: перетащите спрайт шланга (опционально)
4. Запустите сцену - шланг создастся автоматически

#### Вариант B: Ручное создание объекта шланга
1. Создайте пустой GameObject в сцене
2. Добавьте компоненты:
   - `SpriteRenderer` - для отображения спрайта шланга
   - `Collider2D` (BoxCollider2D) с `isTrigger = true`
   - `HoseInteractable` - компонент взаимодействия
3. Настройте `HoseInteractable`:
   - **Prompt Text**: "Взять шланг"
   - **Requires Watering Can**: `true`

### Шаг 2: Создание плесени в игре

#### Вариант A: Использование MoldPrefabCreator (для тестирования)
1. Создайте пустой GameObject в сцене
2. Добавьте компонент `MoldPrefabCreator`
3. Настройте параметры:
   - **Create On Start**: `true` (автоматически создать при запуске)
   - **Position**: координаты где разместить плесень (например, в углу наверху)
   - **Mold Layer**: `8` (или любой другой свободный слой)
4. Запустите сцену - плесень создастся автоматически

#### Вариант B: Ручное создание объекта плесени
1. Создайте пустой GameObject в сцене
2. Добавьте компоненты в следующем порядке:
   - `SpriteRenderer` - для отображения спрайта плесени
   - `Collider2D` (BoxCollider2D или PolygonCollider2D) - для обнаружения взаимодействий
   - `MoldSurface` - основной компонент плесени
   - `MoldInteractable` - интеграция с системой взаимодействий
   - `YSorter` - для правильной сортировки (опционально)

### Шаг 3: Подготовка спрайта плесени

1. Импортируйте спрайт плесени в проект
2. В настройках импорта спрайта:
   - Установите **Read/Write Enabled** = `true`
   - Установите **Sprite Mode** = `Single`
   - Установите **Pixels Per Unit** = `100` (или другое подходящее значение)

### Шаг 4: Настройка слоев

1. **Слой "Interactable" (10)** - для объектов взаимодействия (шланг, лейка, семена)
2. **Слой "Mold" (8)** - для объектов с плесенью
3. Назначьте соответствующие слои:
   - Шланг → слой **Interactable**
   - Плесень → слой **Mold**
4. В `WaterJetController` установите **Mold Mask** на слой "Mold"
5. В `InteractionDetector` убедитесь, что **Mask** включает слой "Interactable"

### Шаг 5: Создание игрока с водяной струей (опционально)

1. Создайте GameObject для игрока
2. Добавьте компоненты:
   - `SpriteRenderer` - для отображения персонажа
   - `WaterJetController` - контроллер струи
   - `YSorter` - для правильной сортировки

3. Настройте `WaterJetController`:
   - **Nozzle**: создайте дочерний объект "Nozzle" и назначьте его
   - **Max Distance**: `10` (максимальная дальность струи)
   - **Mold Mask**: выберите слой с объектами плесени
   - **Paint Interval**: `0.01` (интервал между стираниями)

**Примечание**: Этот шаг не обязателен, так как `MoldInteractable` автоматически создает временный `WaterJetController` при взаимодействии с плесенью.

### Шаг 6: Настройка системы ввода

#### Вариант A: Использование Player Input (рекомендуется)
1. Добавьте компонент `Player Input` на объект игрока
2. Откройте `Assets/Settings/PlayerInput.inputactions`
3. В Input Action Map "Gameplay" добавьте новое действие "Fire"
4. Привяжите действие "Fire" к левой кнопке мыши (`<Mouse>/leftButton`)
5. В `WaterJetController` установите **Use Player Input** = `true`

**Примечание**: В текущем проекте действие "Fire" отсутствует в PlayerInputActions, поэтому система автоматически использует `Input.GetMouseButton(0)` как fallback.

#### Вариант B: Использование Input Action Reference
1. В `WaterJetController` установите **Use Player Input** = `false`
2. Создайте Input Action Reference для действия "Fire"
3. Назначьте его в поле **Fire Action**

#### Вариант C: Старая система ввода (fallback)
1. В `WaterJetController` установите **Use Player Input** = `false`
2. Оставьте **Fire Action** пустым
3. Система автоматически будет использовать `Input.GetMouseButton(0)`

### Шаг 7: Тестирование

1. Запустите сцену
2. Зажмите левую кнопку мыши и направьте курсор на объект с плесенью
3. Проверьте, что:
   - Струя отображается от nozzle к курсору
   - Плесень стирается при попадании
   - Визуальные эффекты работают корректно

## Дополнительные настройки

### Производительность
- Для больших текстур (1024x1024) рекомендуется `paintInterval = 0.01`
- Для меньших текстур можно использовать `paintInterval = 0.005`

### Визуальные эффекты
- Настройте `YSorter` для правильного отображения объектов
- Используйте `MoldSurfaceGizmo` для отладки в редакторе

### Отладка
- Включите гизмосы в Scene View для визуализации области стирания
- Используйте `GetCleanPercent()` для отслеживания прогресса очистки

## Требования

- Unity 2022 LTS или новее
- 2D URP (Universal Render Pipeline)
- New Input System (опционально, но рекомендуется)
- Спрайты с включенным Read/Write Enabled

## Быстрый старт

### Минимальная настройка для тестирования:

#### Вариант A: Использование SceneSetupHelper (рекомендуется)
1. **Добавьте `SceneSetupHelper`** на пустой GameObject в сцене
2. **Настройте параметры**:
   - `Setup On Start = true` (автоматическая настройка)
   - `Create Hose = true`
   - `Create Mold = true`
   - `Hose Position` = (3, 0, 0) - справа от игрока
   - `Mold Position` = (-3, 2, 0) - слева вверху
   - `Interactable Layer = 10`
   - `Mold Layer = 8`
3. **Запустите сцену** - объекты создадутся автоматически

#### Вариант B: Ручное создание
1. **Создайте шланг**:
   - Добавьте `HosePrefabCreator` на пустой GameObject
   - Установите `Create On Start = true`
   - **ВАЖНО**: Убедитесь, что шланг создается на слое **Interactable (10)**
   - Запустите сцену

2. **Создайте плесень**:
   - Добавьте `MoldPrefabCreator` на пустой GameObject
   - Установите `Create On Start = true`
   - Запустите сцену

3. **Убедитесь, что у игрока есть лейка**:
   - Подойдите к лейке в сцене
   - Нажмите E для подбора

4. **Наполните лейку водой**:
   - Подойдите к источнику воды
   - Нажмите E для наполнения

5. **Возьмите шланг**:
   - Подойдите к шлангу
   - Нажмите E для взятия шланга

6. **Очистите плесень шлангом**:
   - Зажмите левую кнопку мыши и направьте курсор на плесень
   - Плесень будет очищаться с помощью шланга

### Готово! 🎉

## Поддержка

При возникновении проблем проверьте:
1. Правильность настройки слоев и масок
2. Включен ли Read/Write Enabled для спрайтов плесени
3. Корректность настройки Input System
4. Назначение всех необходимых ссылок в компонентах
5. Наличие лейки с водой в инвентаре игрока
